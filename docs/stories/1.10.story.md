# Story 1.10 — 스키마 기반 폼 렌더링

Status: Done
Epic: 1 — Template Management
Story: 10

## Dependencies
- Depends on: Story 1.7 — YAML 정식 파서 + TemplateSchema 검증 (Status: Done)
- Depends on: Story 1.8 — 템플릿 선택 페이지(MVP) (Status: Done)
- Depends on: Story 1.9 — PDF Generator API 계약/스텁 (Status: Done)

## Story
내부 담당자로서,
선택한 템플릿의 스키마(TemplateSchema)를 기반으로 폼 UI가 동적으로 렌더링되어
작성 데이터를 정확히 입력·검증할 수 있기를 원한다.

## Acceptance Criteria
1. 스키마 기반 동적 렌더링 (FR4)
   - 쿼리스트링 `?templateId=`로 선택 템플릿을 식별한다(Story 1.8 연계).
   - TemplateSchema의 섹션/필드 정의에 따라 다음 최소 타입을 렌더링한다: `text`, `checkbox`, `select`.
   - 각 필드에 스키마의 `pdf_field_name`과 레이블이 연결된다.
2. 유효성 검증(클라이언트)
   - 필수 항목/타입(문자열/불리언/옵션값) 유효성 검증을 실시하고, 오류 메시지를 필드 하단에 표시한다.
   - 오류 계약 형식은 UI 내부 규칙으로 일관되게 관리하되, 서버 오류 계약(1.7/1.9)은 후속 통합 단계에서 연계한다.
   - 최소 규칙(클라이언트):
     - text: 문자열이며 trim 후 빈 값 불가(필수인 경우)
     - checkbox: 불리언(true/false)
     - select: 값이 스키마의 options 배열에 포함되어야 함
     - 공통: 필수(required=true)인 경우 누락 시 필드별 오류 메시지 표시
3. 상호작용/A11y
   - 키보드 내비게이션 가능, 라벨-컨트롤 연결(`for`/`id`), 오류 메시지 `aria-live=polite` 적용.
   - 섹션 구분 헤더는 시맨틱 요소(`<h2/>` 등)로 렌더링한다.
4. 상태/라우팅
   - 로컬 상태로 입력 값을 관리한다. `templateId`는 URL 파라미터에서 유지한다.
   - “미리보기/다음 단계” 버튼은 후속 스토리(1.11)에서 실제 PDF 생성(1.9 API)로 연결 예정이다.
   - `templateId`가 변경되면 폼 상태를 초기화하고 포커스를 첫 입력 필드로 이동한다.
5. 테스트
   - Unit: 타입별 컴포넌트 렌더링(text/checkbox/select), 필수/타입 검증 오류, 라벨 연결, 키보드 조작.
   - Integration: `/templates/edit?templateId=...` 페이지 렌더(로딩/빈/정상), 간단한 입력-오류 표시 흐름.
6. 문서/앵커 유효성
   - 본 스토리의 문서 참조 앵커가 유효하고 `npm run docs:check` 통과.

참조
- FR4 설문 항목 표시(스키마 기반 렌더링): `docs/prd/acceptance-criteria.md#fr4-설문-항목-표시-스키마-기반-렌더링`
- 코어 워크플로우: `docs/prd/core-workflows.md`
- 컴포넌트: `docs/prd/components.md`

## Tasks / Subtasks
- [x] SchemaForm 컴포넌트 (AC: 1,2,3)
  - [x] `src/app/templates/_components/SchemaForm.tsx`: 섹션/필드 렌더링, 라벨 연결, 오류 표시
  - [x] 타입별 렌더러: TextField/CheckboxField/SelectField (내부 모듈로 구성)

- [x] 편집 페이지 (AC: 1,4)
  - [x] `src/app/templates/edit/page.tsx`: `templateId` 파라미터 수신, 스키마 로드(임시: 인메모리/목)
  - [x] 로딩/빈/오류 상태 뷰 구성

- [x] 검증 로직(클라이언트) (AC: 2)
  - [x] 필수/타입 검증 및 오류 메시지 매핑
  - [x] a11y: 오류 영역 `aria-live=polite`, 포커스 이동 전략(최초 오류로)

- [x] 테스트 (AC 전범위) (AC: 5,6)
  - [x] Unit: 렌더러/검증/a11y
  - [x] Integration: `/templates/edit` 기본 흐름
  - [x] 문서 앵커/링크 점검: `npm run docs:check`

## Dev Notes
- 범위 한정: 서버 연동(PDF 생성/저장)은 제외. 본 스토리는 “폼 렌더/검증”에 집중.
- 데이터 소스: 스키마는 임시(mock) 또는 향후 실제 파일 로드로 대체(1.7/1.5/1.6 기반 설계 유지).
- a11y: 키보드 탭 순서/레이블/오류 라이브영역 및 시맨틱 섹션 헤더 준수.
 - Mock Schema(예시):
   ```json
   {
     "sections": [
       {
         "section_id": "basic",
         "title": "기본 정보",
         "fields": [
           { "type": "text", "pdf_field_name": "company", "label": "회사명", "required": true },
           { "type": "checkbox", "pdf_field_name": "need_demo", "label": "데모 요청" },
           { "type": "select", "pdf_field_name": "size", "label": "규모", "options": ["S","M","L"], "required": true }
         ]
       }
     ]
   }
   ```

## API Specifications
- 본 스토리 직접 API 변화 없음(후속 1.11에서 1.9 API와 연결)

## File Locations
- `src/app/templates/edit/page.tsx` (신규: 편집 페이지)
- `src/app/templates/_components/SchemaForm.tsx` (신규: 스키마 기반 폼)
- `tests/unit/templates/schema-form.spec.tsx` (신규)
- `tests/integration/templates/templates-edit.int.spec.ts` (신규)

## Project Structure Notes
- Next.js/React/TypeScript 스택 기준. 기존 `app/templates` 하위에 `edit` 라우트 추가.
- 테스트는 RTL(happy-dom) 및 vitest 통합 패턴 유지.

## Testing
- Unit
  - 타입별 렌더링(text/checkbox/select)과 라벨 연결 검증
  - 필수/타입 검증 오류 메시지 및 a11y(aria-live) 확인
  - `templateId` 변경 시 상태 초기화 및 첫 필드 포커스 이동 확인

- Integration
  - `/templates/edit?templateId=` 로딩/정상 렌더 및 간단 입력-오류 표시 흐름

- Docs
  - `npm run docs:check` 통과

## References
- Tech Stack: `docs/architecture/tech-stack.md`
- Coding Standards: `docs/architecture/coding-standards.md`
- Source Tree: `docs/architecture/source-tree.md`
- Test Stack: `docs/architecture/test-stack.md`
- Acceptance Criteria: `docs/prd/acceptance-criteria.md#fr4-설문-항목-표시-스키마-기반-렌더링`

## QA Results
Gate: PASS (주의 포함)
Reviewer: QA Quinn
Date: 2025-10-29

요약
- 스키마 기반 폼(SchemaForm)과 편집 페이지(EditPageClient)가 구현되어 text/checkbox/select 렌더링, 레이블 연결, 오류 메시지 표시(aria-live) 및 templateId 변경 시 상태 초기화·포커스 이동을 충족.
- 유닛/통합 테스트 및 문서 앵커 검사가 통과하여 기본 품질 요건 충족.

AC 판정
- AC1: PASS — `text|checkbox|select` 타입 렌더링, `pdf_field_name` 기반 필드 식별 및 레이블 연결 확인.
- AC2: PASS — 클라이언트 검증 규칙(필수/타입/옵션 포함) 및 필드 하단 오류 메시지 표시 구현. 서버 오류 계약은 후속(1.11) 연계 예정.
- AC3: PASS — 라벨-컨트롤 연결, `aria-live=polite` 적용. 키보드 조작은 기본 폼 패턴으로 충족(필요 시 에러 요약/포커스 전략 보강 권고).
- AC4: PASS — 로컬 상태 관리, URL 파라미터의 `templateId` 유지, 변경 시 상태 초기화·첫 필드 포커스 이동.
- AC5: PASS — Unit/Integration 테스트 케이스 충족(렌더/검증/a11y/템플릿 변경).
- AC6: PASS — 문서 앵커 검사 통과.

리스크/권고
- 에러 발생 시 ‘최초 오류 필드로 포커스 이동’ 동작은 onSubmit에서 보완 시 접근성 향상 가능(현재는 aria-live 중심).
- 스키마 소스가 Mock 기준이므로 실제 파일 로드/동기화(1.7/1.5/1.6 경로) 연계 시 스키마 불일치 대비 E2E 검증 권고.

근거(Evidence)
- Unit: `npm run test:unit` (passed)
- Integration: `npm run test:integration` (passed)
- Docs: `npm run docs:check` (passed)

게이트 파일
- `docs/qa/gates/1.10-schema-based-form-rendering.yml`

재검토(2025-10-30)
- 변경사항: 제출 시 최초 오류 필드로 포커스 이동(a11y) 구현 및 유닛 테스트 추가 확인
- 회귀 결과: `npm run test:unit`, `npm run test:integration`, `npm run docs:check` 모두 통과
- 판정: PASS 유지(리스크 수준 변동 없음, 실제 스키마 연계 시 E2E 보강 권고 유지)

## Dev Agent Record
### Agent Model Used
TBD (dev) via Codex CLI — Next.js/React/TypeScript stack
### Debug Log References
2025-10-29: Draft created for 1.10 based on FR4 and components/workflow.
2025-10-29: Implemented SchemaForm (a11y+검증) and Edit page(client wrapper + server route). Added unit/integration tests.
2025-10-29: Executed `npm run test:unit`, `npm run test:integration` — passed. Executed `npm run docs:check` — passed.
2025-10-29: Executed Dev DoD Checklist (`.bmad-core/checklists/story-dod-checklist.md`).
2025-10-30: QA 권고 반영 — 제출 시 최초 오류 필드로 포커스 이동(a11y 개선). 유닛 테스트 추가.
### Completion Notes List
- (Dev 완료 후 작성)
  - Implemented `src/app/templates/_components/SchemaForm.tsx` and `src/app/templates/_components/EditPageClient.tsx`, `src/app/templates/edit/page.tsx`.
  - Added unit test `tests/unit/templates/schema-form.spec.tsx` (렌더링/검증/a11y/템플릿 변경 초기화 + 포커스).
  - Added integration test `tests/integration/templates/templates-edit.int.spec.tsx` (templateId 유무/폼 렌더/Next 버튼).
  - Docs anchors check passed.
  - Applied QA recommendation: focus first invalid field on submit; updated unit tests accordingly.
### File List
- Added: src/app/templates/edit/page.tsx
- Added: src/app/templates/_components/SchemaForm.tsx
- Added: src/app/templates/_components/EditPageClient.tsx
- Added: tests/unit/templates/schema-form.spec.tsx
- Added: tests/integration/templates/templates-edit.int.spec.ts
- Modified: src/app/templates/_components/SchemaForm.tsx
- Modified: tests/unit/templates/schema-form.spec.tsx
### Change Log
YYYY-MM-DD: SM created story draft (Status: Draft).
2025-10-29: PO validated story draft (Status: Ready). (Reviewer: Sarah)
2025-10-30: Dev applied QA recommendation (focus first invalid field) and updated tests.
2025-10-30: PO executed master checklist and set Status: Done. (PO: Sarah)
