# Story 1.14 — FR6 스키마 표준(동적 스키마) 검증/로딩

Status: Ready
Epic: 1 — Template Management
Story: 14

## Dependencies
- Depends on: Story 1.10 — 스키마 기반 폼 렌더링 (Status: Done)
- Depends on: Story 1.13 — FR4 스키마→PDF 필드 매핑 검증/렌더링(스텁) (Status: Done)

## Story
내부 담당자로서,
템플릿 스키마가 정의된 표준(타입/필수/허용 필드/확장 규칙)에 맞는지 서버단에서 검증하고,
유효하지 않은 항목은 명확한 사유와 함께 보고되도록 하여 시스템 일관성과 안정성을 확보하고 싶다.

## Acceptance Criteria
1. 스키마 유효성 통과
   - Given 템플릿 스키마가 타입 요건을 충족할 때
   - When 서버에서 스키마를 검증한다
   - Then 200과 함께 유효로 판단된다
2. 미지원 타입 처리(경고)
   - Given 스키마에 알 수 없는 `type` 값이 포함되어 있을 때
   - When 스키마를 로드한다
   - Then 해당 필드는 무시되고 경고 로그가 남는다(전체 로드는 실패하지 않음)
3. 유효성 실패(422)
   - Given 필수 속성 누락/타입 불일치/금지 필드가 포함된 스키마일 때
   - When 서버에서 스키마를 검증한다
   - Then 422와 `{ code: 'VALIDATION_ERROR', details: { errors: string[] } }`가 반환된다
4. 계약 일관성
   - When 검증 결과를 클라이언트가 수신한다
   - Then `{ code, message, details? }` 계약 및 한국어 메시지로 일관되게 매핑된다
5. 테스트/문서
   - Unit: 스키마 검증기(성공/경고/실패) 케이스
   - Integration: `/api/templates/schema/validate`(가칭) 200/422/경고 경로 검증
   - Docs: `npm run docs:check` 통과

## References
- PRD FR6: `docs/prd/acceptance-criteria.md#fr6-스키마-표준-동적-스키마`
- 테스트 전략: `docs/prd/test-strategy-and-standards.md`
- 구현 레퍼런스: `src/lib/pdf/request.ts` (클라이언트-서버 계약 참고)

## Examples
- Valid(200)
  - `{ "valid": true }`
- Warning(200)
  - `{ "valid": true, "warnings": ["unknown type: foo"] }`
- Invalid(422)
  - `{ "code": "VALIDATION_ERROR", "message": "Invalid schema", "details": { "errors": ["field.name required"] } }`

## Tasks / Subtasks
- [ ] 스키마 표준 정의/타입 선언
  - [ ] `src/lib/templates/schema.ts` (신규): 스키마 타입/필수 속성/허용 필드 정의
  - [ ] 확장 포인트(커스텀 필드 타입) 대비 가드 설계
- [ ] 검증기 구현
  - [ ] `src/lib/templates/schema-validate.ts` (신규): 성공/경고/실패 구분 및 에러 메시지 집계
  - [ ] 한국어 메시지 매핑: `src/lib/errors/pdf.ts` 또는 신규 에러 모듈 재사용
- [ ] 서버 경로 추가(고정)
  - [ ] `src/api/templates-schema-validate.ts` + 라우트 `/api/templates/schema/validate`: 200/422/경고 처리
  - [ ] 응답 계약 `{ code, message, details? }` 적용
- [ ] 테스트 추가
  - [ ] Unit: `tests/unit/templates/schema-validate.spec.ts`
  - [ ] Integration: `tests/integration/templates/templates-schema-validate.int.spec.ts`
- [ ] 문서 앵커/링크 점검: `npm run docs:check`

## Dev Notes
- 실패 기준: 필수 필드 누락/타입 오류/금지 키 포함 → 422
- 경고 기준: 미지원 타입/알 수 없는 확장 키 → 무시 + 경고 로그, 검증은 통과 가능
- i18n: 에러/경고 키를 중앙화하여 한국어 메시지 일관성 유지
- 확장성: 필드 타입 추가 시, 검증기 테이블 기반으로 간단 확장 가능하도록 설계
 - 검증 결과 계약: 200 `{ valid: true, warnings?: string[] }` | 422 `{ code: 'VALIDATION_ERROR', message, details: { errors: string[] } }`

## Project Structure Notes
- 신규 파일 제안:
  - `src/lib/templates/schema.ts`, `src/lib/templates/schema-validate.ts`
  - `src/api/templates-schema-validate.ts`
  - Tests: `tests/unit/templates/schema-validate.spec.ts`, `tests/integration/templates/templates-schema-validate.int.spec.ts`

## Testing
- Unit
  - 정상/경고/실패 케이스(각 1+) 검증, 세부 에러/경고 메시지 확인
- Integration
  - 200/422 경로 및 경고 로그 노출 확인(로그 어댑터 모킹)
- Docs
  - `npm run docs:check` 통과

## QA Results
TBD (QA 작성)

## Dev Agent Record
### Agent Model Used
SM(draft) → Dev(implement) → QA(review) → PO(approve)

### Debug Log References
- 2025-10-31: SM identified next story 1.14 (FR6 schema standard) after 1.13 PASS; dependencies on 1.10/1.13 confirmed.

### Completion Notes List
- N/A (Draft)

### File List
- Planned: src/lib/templates/schema.ts
- Planned: src/lib/templates/schema-validate.ts
- Planned: src/api/templates-schema-validate.ts
- Planned: tests/unit/templates/schema-validate.spec.ts
- Planned: tests/integration/templates/templates-schema-validate.int.spec.ts

### Change Log
2025-10-31: SM created story draft (Status: Draft).
2025-10-31: PO validated story draft (Status: Ready). (Reviewer: Sarah)
