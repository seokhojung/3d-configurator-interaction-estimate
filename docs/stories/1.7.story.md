# Story 1.7 — YAML 정식 파서 + TemplateSchema 검증

Status: Done
Epic: 1 — Template Management
Story: 7

## Dependencies
- Depends on: Story 1.6 — Supabase Storage SDK Integration + RLS Basics (Status: Done)
- Depends on: Story 1.5 — Template Storage Integration (Supabase) (Status: Done)
- Depends on: Story 1.1 — Template Metadata and Basic CRUD API (Status: Done)

## Story
내부 담당자로서,
템플릿 파일(JSON/YAML)에 대해 정식 파서와 공통 스키마 검증을 적용하여,
형식 오류와 스키마 위반을 일관되고 상세하게 감지·보고하고 싶다.

## Acceptance Criteria
1. YAML 정식 파서 도입 및 상세 오류 보고
   - YAML 파일 파싱 실패 시 422 `{ code: VALIDATION_ERROR, message, details: { reason } }`로 상세 사유를 제공한다.
   - MIME/확장자/크기(≤5MB) 정책은 유지한다.
2. TemplateSchema 기반 공통 검증(JSON/YAML 동등)
   - 공통 스키마(섹션/필드/`pdf_field_name` 등)를 정의하고, JSON과 YAML 모두 동일 로직으로 유효성 검증한다.
   - 스키마 위반 시 422 `{ code: VALIDATION_ERROR, message: 'Invalid schema', details: { missing?: string[], typeErrors?: string[] } }` 형태로 구체화한다.
3. 오류 계약/우선순위 유지
   - 오류 우선순위는 기존 표준을 따른다: `401 > 404/403 > 422 > 400/503` 및 `{ code, message, details? }` 포맷 일관 유지.
4. 테스트
   - Unit: 성공 케이스, 필수 누락, 타입 불일치, 대용량(>5MB) 차단, 잘못된 YAML 파싱 실패를 전수 커버한다.
   - Integration: 업로드 API(`POST /api/templates/files`)에 대해 JSON/YAML 각각 성공/실패(422) 경로를 검증한다.
5. 문서/앵커 유효성
   - 본 스토리의 문서 참조 앵커가 유효하고 `npm run docs:check` 통과한다.
6. 업로드 성공 응답 포맷 유지
   - 성공 시 201과 함께 `{ storage_path }` 반환(기존 계약 유지).

참조
- FR6 스키마 표준: `docs/prd/acceptance-criteria.md#fr6-스키마-표준-동적-스키마`
- 데이터 모델(Template File Schema): `docs/prd/data-models.md#2-template-file-schema`
- 테스트 표준: `docs/prd/test-strategy-and-standards.md`

## Tasks / Subtasks
- [x] YAML 정식 파서 도입 (AC: 1)
  - [x] 파서 선택 및 의존성 추가(예: `yaml` 패키지) — 네트워크/라이선스 제약 검토 [Source: docs/prd/cicd-and-environment.md]
  - [x] 파싱 오류를 422로 매핑하고 상세 사유(`details.reason`) 제공 [Source: docs/architecture/coding-standards.md]

- [x] TemplateSchema 정의 및 공통 검증 함수 구현 (AC: 2)
  - [x] `src/lib/templates/schema.ts`: `TemplateSchema` 타입/유효성 검증 함수 `validateTemplateSchema(obj)` 구현 [Source: docs/architecture/source-tree.md]
  - [x] JSON/YAML 공통 경로로 스키마 검증을 일원화 [Source: docs/prd/data-models.md]

- [x] 업로드 API 업데이트 (AC: 1,2,3)
  - [x] `src/api/templates-files.ts`: MIME/확장자/크기 정책 유지, 파싱(JSON/YAML) → `validateTemplateSchema` 경유로 일원화 [Source: docs/architecture/coding-standards.md]
  - [x] 오류 우선순위 및 `{ code, message, details? }` 계약 준수 [Source: docs/architecture/coding-standards.md]
  - [x] 성공 응답 201 + `{ storage_path }` 계약 재확인(회귀 방지)

- [x] 테스트 (AC 전범위) [Source: docs/architecture/test-stack.md]
  - [x] Unit: 성공/필수 누락/타입 오류/대용량/잘못된 YAML
  - [x] Integration: `POST /api/templates/files` JSON/YAML 성공/422 경로
  - [x] 문서 앵커/링크 점검: `npm run docs:check`

## Dev Notes
- 배경/직전 스토리 인사이트
  - 1.6에서 YAML 검증은 휴리스틱 기반이었음. 본 스토리에서 정식 파서와 공통 스키마로 치환 [Source: docs/stories/1.6.story.md]
  - 업로드 API의 오류 계약과 크기/MIME 정책은 유지 [Source: docs/prd/acceptance-criteria.md]

- 기술 고려사항
  - 외부 파서 의존성 추가 시 라이선스/패키지 크기 및 런타임 성능 영향 검토 [Source: docs/prd/cicd-and-environment.md]
  - 스키마 검증은 런타임 비용이 있으므로 필수 항목·타입 체크에 집중(過검증 지양)
  - YAML 정책: 허용 확장자 `yaml|yml`. 파서는 YAML 1.2 기준을 따르며 anchors/aliases 해석 가능하나, 스키마 모델과 불일치하면 422 처리(merge keys 등 고급 기능 포함).

## API Specifications
- 업로드: `POST /api/templates/files` — 201/401/422/503 (기존 유지), JSON/YAML 모두 공통 스키마 검증 경유 [Source: docs/prd/acceptance-criteria.md#fr2-템플릿-저장-supabase-storage]

## File Locations
- `src/lib/templates/schema.ts` (신규: TemplateSchema/validate 함수)
- `src/api/templates-files.ts` (업로드 API — 파서/스키마 경로 일원화)

## Project Structure Notes
- 현 구조(`src/api`, `src/lib/**`, `tests/**`) 내에 스키마 모듈(`src/lib/templates/schema.ts`) 추가 [Source: docs/architecture/source-tree.md]
- 테스트 글롭 및 실행 명령은 기존 표준 준수 [Source: docs/architecture/test-stack.md]

## Testing
- Unit
  - TemplateSchema 유효/무효 분기(필수 누락/타입 오류)
    - 잘못된 JSON 파싱 실패(422 { code: VALIDATION_ERROR, message })
  
- Integration
  - 업로드 API: JSON/YAML 성공/422
- Docs
  - `npm run docs:check` 통과

## References
- Tech Stack: `docs/architecture/tech-stack.md`
- Coding Standards: `docs/architecture/coding-standards.md`
- Source Tree: `docs/architecture/source-tree.md`
- Test Stack: `docs/architecture/test-stack.md`
- Acceptance Criteria: `docs/prd/acceptance-criteria.md#fr6-스키마-표준-동적-스키마`
- Data Models: `docs/prd/data-models.md`

## QA Results
Gate: PASS
Reviewer: QA Quinn
Date: 2025-10-29

요약
- YAML 정식 파서 도입으로 파싱 오류가 422 `{ code: VALIDATION_ERROR, details.reason }` 형태로 일관되게 보고됨.
- JSON/YAML 모두 공통 `TemplateSchema` 검증 경로로 일원화되어 스키마 위반 시 `{ missing[], typeErrors[] }` 등 구체 정보 제공.
- 오류 우선순위 및 응답 포맷 계약(401 > 404/403 > 422 > 400/503, `{ code, message, details? }`)을 준수함.
- 성공 응답 201 + `{ storage_path }` 계약 유지 확인.
- Dev Agent Record에 따르면 Unit/Integration 테스트 및 `npm run docs:check` 모두 통과.

AC 판정
- AC1: PASS — YAML 파싱 실패를 422로 매핑하고 상세 사유 제공. 파일 정책(확장자/MIME/≤5MB) 유지 확인.
- AC2: PASS — JSON/YAML 공통 스키마 검증 구현 및 위반 상세 정보 제공.
- AC3: PASS — 오류 우선순위/표준 오류 포맷 일관 유지.
- AC4: PASS — 유닛(성공/필수 누락/타입 오류/대용량/잘못된 YAML) 및 통합 테스트(업로드 API JSON/YAML 성공/422) 커버.
- AC5: PASS — 문서 앵커 검사 통과.
- AC6: PASS — 업로드 성공 시 201 + `{ storage_path }` 포맷 유지.

리스크/주의사항
- YAML 1.2 고급 기능(anchors/aliases/merge keys) 사용 시 스키마 모델과 불일치하는 확장 표현이 들어올 수 있음: 현재는 스키마 불일치로 422 처리되나, 회귀 방지를 위해 해당 케이스의 회귀 테스트 추가 권고.
- YAML 파서의 메모리 사용량 및 YAML bomb류 페이로드 방어: 5MB 상한이 있으나 파싱 복잡도 악용 가능성에 대비해 파서 옵션 점검 및 타임아웃/노드 수 제한 고려 권고.
- 오류 메시지 세부(reason/typeErrors) 포맷은 외부 문서화 필요(클라이언트 의존도 최소화 차원).

근거(Evidence)
- Unit: `npm run test:unit` (passed)
- Integration: `npm run test:integration` (passed)
- Docs: `npm run docs:check` (passed)

게이트 파일
- `docs/qa/gates/1.7-yaml-parser-templateschema-validation.yml`

## Dev Agent Record
### Agent Model Used
James (dev) via Codex CLI — vitest/TypeScript stack
### Debug Log References
YYYY-MM-DD: Draft created for 1.7 based on FR6 and backlog notes.
2025-10-28: Implemented YAML parser integration and unified schema validation.
2025-10-28: Added `validateTemplateSchema` and updated upload API flow.
2025-10-28: Executed `npm run test:unit`, `npm run test:integration` — all tests passed.
2025-10-28: Executed `npm run docs:check` — passed.
### Completion Notes List
- (Dev 완료 후 작성)
  - Added `src/lib/templates/schema.ts` with minimal runtime schema validator.
  - Updated `src/api/templates-files.ts` to use `yaml` parser and common validator.
  - Added unit tests for schema; expanded integration tests for YAML success/failure and >5MB block.
  - All AC satisfied: detailed parse errors, unified schema validation, error contract preserved.
  - Executed DoD: tests (unit/integration) passed, docs anchors check passed, file list updated, error contracts verified.
### File List
- Added: src/lib/templates/schema.ts
- Modified: src/api/templates-files.ts
- Added: tests/unit/template-schema.spec.ts
- Modified: tests/integration/templates-files.int.spec.ts
### Change Log
YYYY-MM-DD: SM created story draft (Status: Draft).
YYYY-MM-DD: PO validated story draft (Status: Ready).
2025-10-28: Dev implemented story 1.7, added tests, and updated docs anchors.
2025-10-28: Dev executed Story DoD checklist and set status to Ready for Review.
2025-10-29: PO approved QA PASS and promoted status to Done. (Reviewer: Sarah)



